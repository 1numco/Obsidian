
Гарантии безопасности исключений

Программа на С++ - очень интересное явление. Вроде мощный, подкаченный, умный и скоростной парень. Но вот проблема. Ходить не умеет нормально. То в ноги себе стреляет, то падает периодически. В общем, беда у него с ходьбой. У этого могут быть разные причины. Все из них даже трудно в голове удержать. Но сегодня обсудим, какие есть гипсы, лангеты и костыли, которые помогут этому парню нормально ходить при работе с исключениями.

Даже не зная, что вы работаете с исключениями - вы уже работаете с ними. Даже обычный, казалось бы, безобидный new может кинуть std::bad_alloc. И все, приплыли.

Обрабатывать исключения можно по-разному и это будет давать разные результаты. От того, как обрабатываются исключения в модуле, зависит, какие гарантии он может дать в случае возникновения исключительной ситуации.

А это очень важная штука, потому что взаимодействующий с модулем код полагается на его адекватное поведение, которое с легкостью может быть нарушено, если нет гарантий безопасности.

Итак, существует 3 гарантии безопасности исключений:

Базовая гарантия. Формулировка разнится, но более общая звучит так: "после возникновения исключения программа должна остаться в согласованном состоянии". Теперь на рабоче-крестьянском: не должно быть утечек памяти и должны сохраняться все инварианты классов. С утечками, думаю, все понятно. Инвариант - некое логически согласованное состояние системы. Если класс владеет массивом и содержит поле для его размера, то инвариантом этого класса будет совпадение реального размера массива со значением поля-размера. Для класса "футбольная команда" инвариантом будет количество игроков - 11. Кого-то удалили, кого-то заменили, кто-то съел товарища - число игроков в команде всегда сохраняется(некоторые из них правда могут в самой игре не участвовать). И так далее. Вот такие штуки должны сохраняться. Нельзя, чтобы дата создания чего-то была больше текущего дня, ну никак.

Строгая гарантия. Если при выполнении операции возникает исключение, операция не должна оказать на систему никакого влияния. То есть пан или пропал. Либо вся операция выполняется успешно и ее результат применяется, либо система откатывается в состояние до выполнения операции. Это свойство программы называется транзакционностью. 

Гарантия отсутствия исключений. Ни при каких обстоятельствах не будет брошено исключение. Легко сказать, но тяжело сделать. Обильное множество стандартных штук-дрюк могут генерировать исключения при работе и это мешает писать большие объемы кода с этой гарантией.

Надо сказать, что эти гарантии вкладываются друг в друга, как матрешки. Отсутствие исключений требует транзакционности и базовой гарантии, транзакционность требует базовитости.

Но это не значит, что используя модуль с какой-либо гарантией, вызывающий код автоматически приобретает ту же гарантию. Например в свап-идиоме используется std::swap, которая не генерирует исключений, чтобы реализовать строгую гарантию присваивания объектов.

Тема интересная, будем потихоньку ее разбирать с примерами по каждой гарантии.

Be a guarantor. Stay cool.

#base