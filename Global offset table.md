Продолжаем изучать тонкости работы с динамическими библиотеками и как происходит разрешение адресов переменных и функций при работе с этими библиотеками. Сегодня препарируем сущность под названием глобальная таблица смещений или GOT на жидо-англо-саксонский манер.

В разделяемом библиотечном или динамически связанном исполняемом файле GOT представляет собой структуру данных, содержащую набор адресов памяти. Эти адреса соответствуют глобальным переменным и функциям, определенным или используемым внутри библиотеки или исполняемого файла.

При загрузке программы во время выполнения динамический связыватель/загрузчик обновляет GOT с фактическими адресами переменных и функций, разрешая все зависимости. GOT сопоставляет символы в программном коде с соответствующими абсолютными адресами памяти. Почему это нужно делать? И почему это нельзя сделать заранее? Дело в том, что код библиотеки загружается в другой адрес памяти при каждом запуске программы. Адрес памяти времени выполнения,  где лежит конкретная переменная или функция, неизвестен до запуска программы, поэтому и не может быть жестко запрограммирован компилятором во время компиляции.

Глобальная таблица смещений тесно взаимодействует с таблицей связи процедур (Procedure Linkage Table, PLT). Пост про нее можно посмотреть тут. Но если вкратце, то PLT содержит набор заглушек-трамплинов, которые обрабатывают первый вызов функции. Когда функция вызывается впервые, PLT передает управление записи GOT для этой функции, чтобы разрешить фактический адрес функции. Последующие вызовы обходят PLT и используют разрешенный адрес из GOT.

С использованием таблицы смещений оверхед динамического связывания сведен к минимуму, позволяя эффективное и гибкое выполнение разделяемых библиотек.

Мы поговорили, что представляют из себя PLT и GOT по отдельности, но пока не очень понимаем, как в деталях происходит их взаимодействие. Эти сущности по сути решают одну проблему - вызывающему коду нужно знать адреса переменных и функций из разделяемых библиотек, но изначально у него этого знания нет. И по-отдельности в них нет смысла. Поэтому в будущем расскажу про тонкости их совместной работы. 

Stay in touch. Stay cool.