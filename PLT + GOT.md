В прошлых постах тык и тык мы поговорили, что такое Procedure Linkege Table и Global Offset Table. Или таблица связи процедур и глобальная таблица смещений на великорусском. Это очень тесносвязанные понятия и работают они в синергии для разрешения адресов функций. В этом посте попробую описать верхнеуровневый протокол их взаимодействия для решения этой задачи. Давайте рассмотрим полную связку работы PLT и GOT от момента загрузки библиотеки до повторного вызова функции из этой библиотеки. Поехали:

1. Загрузка разделяемой библиотеки:
    
    - При загрузке библиотеки динамический связыватель/загрузчик просматривает ее секцию символов и определяет, какие глобальные функции и переменные содержатся в библиотеке.
    - Динамический связыватель/загрузчик(ld.so) создает PLT для вызова функций из библиотеки и GOT для разрешения адресов глобальных переменных и функций.
    
2. Первый вызов функции:
    
    - Когда происходит первый вызов функции из библиотеки, используется соответствующая запись PLT.
    - PLT содержит заглушку, которая вызывает ленивого разрешителя (lazy resolver), ответственного за разрешение адреса вызываемой функции.
    - Ленивый разрешитель смотрит в таблицу смещений и ищет там адрес. Так как вызов первый, он находит там фигу и обращается к динамическому связывателю/загрузчику и запрашивает точный адрес функции.
    - Связыватель находит фактическим адрес функции и обновляет соответствующую запись в GOT.
    - PLT затем передает управление к разрешенному адресу в GOT, и теперь происходит вызов функции.
    
3. Последующие вызовы функции:
    
    - После первого вызова функции, адрес функции уже известен и записан в соответствующую запись в GOT.
    - При следующих вызовах функции PLT просто перенаправляет выполнение на эту запись в GOT, которая и содержит адрес.
    
Как я сказал выше, это довольно верхнеуровневый протокол взаимодействия этих двух сущностей. Но в целом этого описания будет достаточно для понимания того, что происходит. Такие топики относятся к хардкорным вещам и вряд ли вам пригодятся в вашей повседневной разработке. Если вам интересны детали, то можете посмотреть довольно подробную с точки зрения инструкций ассемблера тут.https://rus-linux.net/MyLDP/algol/Shared-Libraries/Shared-Libraries-1.5.5.html

Зачем это знать? Помимо банального "это база", здесь можно расковырять интересную деталь. GOT и PLT - отличный пример внедрения индирекции. Без них динамическому загрузчику пришлось бы на каждый вызов функции ходить и искать ее адрес в библиотеке. Как вы понимаете, это сильно бы ударило по перформансу. Поэтому круто было бы внедрить промежуточные сущности, которые бы решали проблему сохранения адресов для дальнейшего использования. Таблицы и являются такими вещами. Это крутое архитектурное решение и насмотренности на такого рода решения будет хорошим подспорьем для развития собственных навыков проектирования.

Stay hardcore. Stay cool.

![[Pasted image 20231217220827.png]]